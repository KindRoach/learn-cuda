.version 7.0 // CUDA 11.0
.target sm_80
.address_size 64

.visible .entry add_one(
    .param .u64 arr_ptr,   // array pointer
    .param .u32 size       // number of elements
)
{
    // Registers
    .reg .u32 tid, bid, bdim, idx, size_u32;
    .reg .u32 r1;
    .reg .u64 ptr;
    .reg .pred p;

    // Thread/block indices
    mov.u32 tid,  %tid.x;
    mov.u32 bid,  %ctaid.x;
    mov.u32 bdim, %ntid.x;

    // idx = blockIdx.x * blockDim.x + threadIdx.x
    mad.lo.u32 idx, bid, bdim, tid;

    // Load parameters
    ld.param.u64 ptr,      [arr_ptr];
    ld.param.u32 size_u32, [size];

    // Bounds check: if (idx >= size) return;
    setp.ge.u32 p, idx, size_u32;
    @p bra DONE;

    // arr[idx] += 1
    // NOTE: This assumes arr points to 32-bit elements.
    ld.global.u32 r1, [ptr + idx*4];
    add.u32       r1, r1, 1;
    st.global.u32      [ptr + idx*4], r1;

DONE:
    ret;
}
